/*
Script Generated By : Converter.py
Date                : 2023-11-27 15:49:00"
Description         : "Converted input.sql to redshift_output.sql"
*/
with ref_is_pend_tobacco_desc as (
select 1 as tobacco_desc_key_id, '' as tobacco_desc_cd, '' as tobacco_desc, '' as tobacco_desc_abbrev, '' as src_sys_name, 1 as batch_num, date('01-01-1900') as load_dts, '' as lst_updt_usr, date('01-01-1900') as lst_updt_dts
),


select distinct
        rdc.dim_chnl_id, rdc.sub_chnl_cd, ew.extrnl_whlslr_nm as "external", substring(internal_notes, 0, charindex('//', internal_notes)) as "is", ppe.plcy_num as "policy #",
        /* rdp.insured_name as [insured], */
        nvl(insured_last_name, '') || ', ' || nvl(insured_first_name, '') as insured,
        case
            when ppe.lob_cd = 'term' then ppe.prod_premium_amt
            when nvl(ppe.tgt_premium_amt, 0) = 0 and nvl(ppe.prod_premium_amt, 0) = 0 then (case
                when (substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), 0, charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))))::varchar(4000)) = 1 then cast (substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), 0, charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)))) as numeric(19, 4))
                else 0
            end)
            when nvl(ppe.tgt_premium_amt, 0) = 0 and nvl(ppe.prod_premium_amt, 0) <> 0 then nvl(ppe.prod_premium_amt, 0)
            else nvl(ppe.tgt_premium_amt, 0)
        end as target,
        case
            when psc.plcy_status_desc like 'reissue%' then 'reissue'
            when psc.plcy_status_desc like 'rewrite%' then 'rewrite'
            else psc.plcy_status_desc
        end as status, rdp.face_amt as "face amt", rdp.undrwrtr_nm as uw, ppe.csr_id as "nba id", convert (varchar(300), null) as "nba name", (nvl(ppe.tobacco_desc_abbrev, nvl(/*tobacco_desc_abbrev */, '')) || '-' || (case
            when ppe.insrd_ratg_val_cd is null then (nvl(case
                when ppe.insrd_ratg_typ_txt like '%flat%' then '-' || 'fe:' || null || '/' || null || 'yrs'
                else ''
            end, ''))
            when ppe.insrd_ratg_val_cd = '$1.50 / unit' then ''
            when ppe.insrd_ratg_val_cd = '$1.50/ unit' then ''
            when ppe.insrd_ratg_val_cd = '$10.00/ unit' then ''
            when ppe.insrd_ratg_val_cd = '$12.50/ unit' then ''
            when ppe.insrd_ratg_val_cd = '$15.00/ unit' then ''
            when ppe.insrd_ratg_val_cd = '$2.00/ unit' then ''
            when ppe.insrd_ratg_val_cd = '$2.50/ unit' then ''
            when ppe.insrd_ratg_val_cd = '$3.00/ unit' then ''
            when ppe.insrd_ratg_val_cd = '$3.50/ unit' then ''
            when ppe.insrd_ratg_val_cd = '$5.00/ unit' then ''
            when ppe.insrd_ratg_val_cd = '$650.00' then ''
            when ppe.insrd_ratg_val_cd = '$7.50/ unit' then ''
            when ppe.insrd_ratg_val_cd = '0' then ''
            when ppe.insrd_ratg_val_cd = '1' then ''
            when ppe.insrd_ratg_val_cd = '10' then ''
            when ppe.insrd_ratg_val_cd = '11' then ''
            when ppe.insrd_ratg_val_cd = '12' then ''
            when ppe.insrd_ratg_val_cd = '2' then ''
            when ppe.insrd_ratg_val_cd = '3' then ''
            when ppe.insrd_ratg_val_cd = '3 times ins. age' then ''
            when ppe.insrd_ratg_val_cd = '4' then ''
            when ppe.insrd_ratg_val_cd = '5' then ''
            when ppe.insrd_ratg_val_cd = '6' then ''
            when ppe.insrd_ratg_val_cd = '7' then ''
            when ppe.insrd_ratg_val_cd = '8' then ''
            when ppe.insrd_ratg_val_cd = '9' then ''
            when ppe.insrd_ratg_val_cd = 'a t-1-a (+25%)' then 'table a'
            when ppe.insrd_ratg_val_cd = 'b t-2-b (+50%)' then 'table b'
            when ppe.insrd_ratg_val_cd = 'c t-3-c (+75%)' then 'table c'
            when ppe.insrd_ratg_val_cd = 'd t-4-d (+100%)' then 'table d'
            when ppe.insrd_ratg_val_cd = 'e t-5-e (+125%)' then 'table e'
            when ppe.insrd_ratg_val_cd = 'f t-6-f (+150%)' then 'table f'
            when ppe.insrd_ratg_val_cd = 'g t-7-g (+175%)' then 'table g'
            when ppe.insrd_ratg_val_cd = 'h t-8-h (+200%)' then 'table h'
            when ppe.insrd_ratg_val_cd = 'i t-9-i (+225%)' then 'table i'
            when ppe.insrd_ratg_val_cd = 'j t-10-j (+250%)' then 'table j'
            when ppe.insrd_ratg_val_cd = 'k t-11-k (+275%)' then 'table k'
            when ppe.insrd_ratg_val_cd = 'l t-12-l (+300%)' then 'table l'
            when ppe.insrd_ratg_val_cd = 'm t-13-m (+325%)' then 'table m'
            when ppe.insrd_ratg_val_cd = 'n t-14-n (+350%)' then 'table n'
            when ppe.insrd_ratg_val_cd = 'o t-15-o (+375%)' then 'table o'
            when ppe.insrd_ratg_val_cd = 'p t-16-p (+400%)' then 'table p'
            when ppe.insrd_ratg_val_cd = 'q t-17-q (+425%)' then 'table q'
            when ppe.insrd_ratg_val_cd = 'r t-18-r (+450%)' then 'table r'
            when ppe.insrd_ratg_val_cd = 's t-19-s (+475%)' then 'table s'
            when ppe.insrd_ratg_val_cd = 't t-20-t (+500%)' then 'table t'
            when ppe.insrd_ratg_val_cd = 'u t-u-3(+988%)' then 'table u'
            when ppe.insrd_ratg_val_cd = 'user defined' then ''
            when ppe.insrd_ratg_val_cd = 'v t-u(+999%)' then 'table v'
            when ppe.insrd_ratg_val_cd = 'w t-u-0(+999%)' then 'table w'
            when ppe.insrd_ratg_val_cd = 'x user defined' then ''
            when ppe.insrd_ratg_val_cd = 'x1.5' then ''
            when ppe.insrd_ratg_val_cd = 'x2.0' then ''
            when ppe.insrd_ratg_val_cd = 'x2.5' then ''
            when ppe.insrd_ratg_val_cd = 'x3.0' then ''
            else ''
        end)) as "uw decision", ppe.plcy_state_cd as state, f.dim_advsr_id, da.advsr_ssn_id,
        case
            when da.advsr_full_nm like '%merrill lynch%' or da.advsr_full_nm like '%small business ins%' or da.advsr_full_nm like '%morgan stanley%' then (case
                when rtrim(ltrim(substring(substring(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)))), charindex('//', substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))))) + 2, length(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)))))), 0, charindex('//', substring(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)))), charindex('//', substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))))) + 2, length(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)))))))))) <> '' then substring(substring(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)))), charindex('//', substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))))) + 2, length(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)))))), 0, charindex('//', substring(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)))), charindex('//', substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))))) + 2, length(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))))))))
                else da.advsr_full_nm
            end)
            else da.advsr_full_nm
        end as agent,
        /* da.advsr_full_nm as [agent], */
        case
            when da.advsr_full_nm like '%merrill lynch%' or da.advsr_full_nm like '%small business ins%' or da.advsr_full_nm like '%morgan stanley%' then (case
                when ltrim(rtrim(substring(substring(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)))), charindex('//', substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))))) + 2, length(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)))))), charindex('//', substring(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)))), charindex('//', substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))))) + 2, length(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))))))) + 2, length(substring(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)))), charindex('//', substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))))) + 2, length(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)))))))))) <> '' then substring(substring(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)))), charindex('//', substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))))) + 2, length(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)))))), charindex('//', substring(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)))), charindex('//', substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))))) + 2, length(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))))))) + 2, length(substring(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)))), charindex('//', substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))))) + 2, length(substring(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes)), charindex('//', substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))) + 2, length(substring(internal_notes, charindex('//', internal_notes) + 2, length(internal_notes))))))))
                else nvl(da.currnt_city_nm, '') || ', ' || nvl(da.currnt_state_cd, '')
            end)
            else nvl(da.currnt_city_nm, '') || ', ' || nvl(da.currnt_state_cd, '')
        end as "agent address", substring(substring(substring(ppe.intrnl_notes_txt, charindex('//', ppe.intrnl_notes_txt) + 2, length(ppe.intrnl_notes_txt)), charindex('//', substring(ppe.intrnl_notes_txt, charindex('//', ppe.intrnl_notes_txt) + 2, length(ppe.intrnl_notes_txt))) + 2, length(substring(ppe.intrnl_notes_txt, charindex('//', ppe.intrnl_notes_txt) + 2, length(ppe.intrnl_notes_txt)))), 0, charindex('//', substring(substring(ppe.intrnl_notes_txt, charindex('//', ppe.intrnl_notes_txt) + 2, length(ppe.intrnl_notes_txt)), charindex('//', substring(ppe.intrnl_notes_txt, charindex('//', ppe.intrnl_notes_txt) + 2, length(ppe.intrnl_notes_txt))) + 2, length(substring(ppe.intrnl_notes_txt, charindex('//', ppe.intrnl_notes_txt) + 2, length(ppe.intrnl_notes_txt)))))) as notes, ppe.intrnl_notes_txt, convert (varchar(6000), null) as "outstanding reqs", pr.prod_plan_desc as product, df.firm_nm as office, f.trx_procss_dt as "submit date", rdp.plcy_status_chng_dt as "status date", ppe.contact_email_id as "contact email", ppe.contact_cc_email_id as "contact cc email", f.dim_chnl_id, f.dim_plcy_id
        --into "#temp55_proc1"
        from vikas_dummy.dim_plcy as ppe
        join vikas_dummy.fct_dly_plcy_trx as f
            on ppe.dim_plcy_id = f.dim_plcy_id
        join vikas_dummy.bridge channel subchannel relationship as rdc
            on f.dim_chnl_id = rdc.dim_chnl_id
        join vikas_dummy.dim_prod as pr
            on f.dim_prod_id = pr.dim_prod_id
        left outer join vikas_dummy.dim_plcy as psc
            on /*status_cd_key_id */ = /*status_cd_key_id */
        left outer join vikas_dummy.dim_plcy as rdp
            on ppe.dim_plcy_id = rdp.dim_plcy_id
        left outer join vikas_dummy.dim_advsr as da
            on f.dim_advsr_id = da.dim_advsr_id
        left outer join vikas_dummy.dim_firm as df
            on f.dim_firm_id = df.dim_firm_id
        left outer join vikas_dummy.brdg_terrty_extrnl_whlslr_reltnshp as ter
            on f.dim_terrty_id = ter.dim_terrty_id
        left outer join vikas_dummy.dim_extrnl_whlslr as ew
            on ter.dim_extrnl_whlslr_id = ew.extrnl_whlslr_id
        left outer join vikas_dummy.ref_is_pend_tobacco_desc as ipt
            on nvl(/*tobacco_rating_applied */, 'ns') = ipt.tobco_desc
        where ((psc.plcy_status_cd in ('pnd') or (psc.plcy_status_desc in ('trial closed') and null < 15)) and null < 15 and f.is_compensbl_flg = 'y' and f.trx_grp_cd = 'p' and rdc.dim_chnl_id in ('wrh', 'bnk') and pr.prod_sub_grp_cd = 'life' and nvl(ppe.intrnl_notes_txt, 'oo') not like 'xx%' and nvl(ppe.intrnl_notes_txt, 'oo') not like 'mga%' and ppe.lob_cd <> 'ulltc' and ppe.origin_cd = 'nbl' and ppe.applctn_typ_cd in ('com', 'con', 'exc', 'frm', 'tri'))
        order by 3 nulls first
